<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Recoding my grow of technology."><title>disamy-mbr | blogLi</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">disamy-mbr</h1><a id="logo" href="/.">blogLi</a><p class="description">学生，码农，工程师</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a><a href="/comments"><i class="fa fa-comments"> 留言</i></a><a href="/books"><i class="fa fa-rss"> 书单</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">disamy-mbr</h1><div class="post-meta">Jul 17, 2016<span> | </span><span class="category"><a href="/categories/学习笔记/">学习笔记</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/07/17/disamy-mbr/" href="/2016/07/17/disamy-mbr/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#"><span class="toc-number">1.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#流程"><span class="toc-number">2.</span> <span class="toc-text">流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#细节"><span class="toc-number">3.</span> <span class="toc-text">细节</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#获取"><span class="toc-number"></span> <span class="toc-text">获取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#获取mbr"><span class="toc-number">1.</span> <span class="toc-text">获取mbr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装"><span class="toc-number">2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#反汇编mbr"><span class="toc-number">3.</span> <span class="toc-text">反汇编mbr</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#分析"><span class="toc-number"></span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#二进制mbr"><span class="toc-number">1.</span> <span class="toc-text">二进制mbr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#反汇编mbr-1"><span class="toc-number">2.</span> <span class="toc-text">反汇编mbr</span></a></li></ol></div></div><div class="post-content"><p> 今天把我们每次开机都用到的MBR，反汇编看看里面的引导代码是怎么样的顺便说一下<br> MBR 相关的开机过程。以及我们经常用的U盘自启动<br> 程序到底值怎么玩的。</p>
<h2 id=""><a href="#" class="headerlink" title=""></a><a id="more"></a></h2><p> window开机流程</p>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><pre><code>加电--&gt;BIOS--&gt; MBR--&gt; DPT--&gt; pbr--&gt; Bootmgr--&gt; bcd--&gt; Winload.exe---
</code></pre><p>—-&gt; 内核加载–&gt; 整个windows7系统</p>
<h2 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h2><p>在CPU上电之后，若由硬盘启动，则BIOS将硬盘的主引导记录（位于0柱面、0磁道、1扇区）读入7C00处<br>然后将控制权交给主引导代码。主引导代码的任务包括：<br>扫描分区表，找到一个激活(可引导)分区；<br>找到激活分区的起始扇区；<br>将激活分区的引导扇区装载到内存7C00处；<br>将控制权交给引导扇区代码；</p>
<p>如果主引导代码无法完成上述任务，它将显示以下错误信息之一：<br>No active partition.<br>Invalid partition table.<br>Error loading operating system.<br>Missing operating system.</p>
<p>机器加电或按reset键后都要进行系统复位，复位后CS=FFFFH，IP=0000H，那么自然就从FFFF:0000H<br>处开始执行指令，这个地方只有一条JMP指令跳转到系统自检程序处，系统自检完成后把软盘的第一<br>个扇区（如果由软盘启动）或者硬盘的第一个扇区，即MBR扇区（如果由硬盘启动）读入到0:7C00H处<br>然后把控制权交出，从0:7C00H处继续执行。  </p>
<p>下面就是硬盘的MBR代码分析：<br>其中的引导扇区是指硬盘相应分区的第一个扇区，是和操作系统有关的。操作系统的引导是由它来完成的，而MBR并不负责，MBR和操作系统无关。引导扇区的任务是把控制权转交给操作系统的引导程序。 </p>
<p>程序流程：<br>1 将程序代码由0:7C00H移动到0:0600H（注，BIOS把MBR放在0:7C00H处）<br>2 搜索可引导分区，即80H标志<br>成功：goto 3<br>失败：跳入ROM BASIC<br>无效分区表：goto 5<br>3 读引导扇区<br>失败：goto 5<br>成功：goto 4<br>4 验证引导扇区最后是否为55AAH<br>失败：goto 5<br>成功：goto 6<br>5 打印错误进入无穷循环<br>6 跳到0:7C00H进行下一步启动工作</p>
<h1 id="获取"><a href="#获取" class="headerlink" title="获取"></a>获取</h1><h2 id="获取mbr"><a href="#获取mbr" class="headerlink" title="获取mbr"></a>获取mbr</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">window可以直接用hex打开，然后直接拷贝成文件</div><div class="line">linux一条<span class="selector-tag">dd</span> 命令搞定，参数不明白就 --help look</div><div class="line"></div><div class="line"><span class="selector-tag">dd</span> <span class="keyword">if</span>=/dev/sda of=~/Desktop/mbr<span class="selector-class">.bin</span> bs=<span class="number">512</span> count=<span class="number">1</span></div></pre></td></tr></table></figure>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">安装nasm </div><div class="line">sudo apt-<span class="keyword">get</span> install nasms</div></pre></td></tr></table></figure>
<h2 id="反汇编mbr"><a href="#反汇编mbr" class="headerlink" title="反汇编mbr"></a>反汇编mbr</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//把mbr.bin 反汇编到mbr.asm</span></div><div class="line">ndisasm mbr<span class="selector-class">.bin</span> &gt; mbr.asm</div></pre></td></tr></table></figure>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><h2 id="二进制mbr"><a href="#二进制mbr" class="headerlink" title="二进制mbr"></a>二进制mbr</h2><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">od -x mbr.bin</div><div class="line"><span class="number">0000000</span> c033 d08e <span class="number">00</span>bc <span class="number">8e7</span>c <span class="number">8</span>ec0 bed8 <span class="number">7</span>c00 <span class="number">00</span>bf</div><div class="line"><span class="number">0000020</span> b906 <span class="number">0200</span> f3fc <span class="number">50</span>a4 <span class="number">1</span>c68 cb06 b9fb <span class="number">0004</span></div><div class="line"><span class="number">0000040</span> bebd <span class="number">8007</span> <span class="number">007</span>e <span class="number">7</span>c00 <span class="number">0</span>f0b <span class="number">0e85</span> <span class="number">8301</span> <span class="number">10</span>c5</div><div class="line"><span class="number">0000060</span> f1e2 <span class="number">18</span>cd <span class="number">5688</span> <span class="number">5500</span> <span class="number">46</span>c6 <span class="number">0511</span> <span class="number">46</span>c6 <span class="number">0010</span></div><div class="line"><span class="number">0000100</span> <span class="number">41</span>b4 aabb cd55 <span class="number">5</span>d13 <span class="number">0</span>f72 fb81 aa55 <span class="number">0975</span></div><div class="line"><span class="number">0000120</span> c1f7 <span class="number">0001</span> <span class="number">0374</span> <span class="number">46</span>fe <span class="number">6610</span> <span class="number">8060</span> <span class="number">107</span>e <span class="number">7400</span></div><div class="line"><span class="number">0000140</span> <span class="number">6626</span> <span class="number">0068</span> <span class="number">0000</span> <span class="number">6600</span> <span class="number">76</span>ff <span class="number">6808</span> <span class="number">0000</span> <span class="number">0068</span></div><div class="line"><span class="number">0000160</span> <span class="number">687</span>c <span class="number">0001</span> <span class="number">1068</span> b400 <span class="number">8</span>a42 <span class="number">0056</span> f48b <span class="number">13</span>cd</div><div class="line"><span class="number">0000200</span> <span class="number">839</span>f <span class="number">10</span>c4 eb9e b814 <span class="number">0201</span> <span class="number">00</span>bb <span class="number">8</span>a7c <span class="number">0056</span></div><div class="line"><span class="number">0000220</span> <span class="number">768</span>a <span class="number">8</span>a01 <span class="number">024</span>e <span class="number">6e8</span>a cd03 <span class="number">6613</span> <span class="number">7361</span> fe1c</div><div class="line"><span class="number">0000240</span> <span class="number">114</span>e <span class="number">0</span>c75 <span class="number">7e80</span> <span class="number">8000</span> <span class="number">840</span>f <span class="number">008</span>a <span class="number">80</span>b2 <span class="number">84</span>eb</div><div class="line"><span class="number">0000260</span> <span class="number">3255</span> <span class="number">8</span>ae4 <span class="number">0056</span> <span class="number">13</span>cd eb5d <span class="number">819</span>e fe3e <span class="number">557</span>d</div><div class="line"><span class="number">0000300</span> <span class="number">75</span>aa ff6e <span class="number">0076</span> <span class="number">8</span>de8 <span class="number">7500</span> fa17 d1b0 <span class="number">64e6</span></div><div class="line"><span class="number">0000320</span> <span class="number">83e8</span> b000 e6df e860 <span class="number">007</span>c ffb0 <span class="number">64e6</span> <span class="number">75e8</span></div><div class="line"><span class="number">0000340</span> fb00 <span class="number">00</span>b8 cdbb <span class="number">661</span>a c023 <span class="number">3</span>b75 <span class="number">8166</span> <span class="number">54</span>fb</div><div class="line"><span class="number">0000360</span> <span class="number">5043</span> <span class="number">7541</span> <span class="number">8132</span> <span class="number">02</span>f9 <span class="number">7201</span> <span class="number">662</span>c <span class="number">0768</span> <span class="number">00</span>bb</div><div class="line"><span class="number">0000400</span> <span class="number">6600</span> <span class="number">0068</span> <span class="number">0002</span> <span class="number">6600</span> <span class="number">0868</span> <span class="number">0000</span> <span class="number">6600</span> <span class="number">6653</span></div><div class="line"><span class="number">0000420</span> <span class="number">6653</span> <span class="number">6655</span> <span class="number">0068</span> <span class="number">0000</span> <span class="number">6600</span> <span class="number">0068</span> <span class="number">007</span>c <span class="number">6600</span></div><div class="line"><span class="number">0000440</span> <span class="number">6861</span> <span class="number">0000</span> cd07 <span class="number">5</span>a1a f632 <span class="number">00</span>ea <span class="number">007</span>c cd00</div><div class="line"><span class="number">0000460</span> a018 <span class="number">07</span>b7 <span class="number">08</span>eb b6a0 eb07 a003 <span class="number">07</span>b5 e432</div><div class="line"><span class="number">0000500</span> <span class="number">0005</span> <span class="number">8</span>b07 acf0 <span class="number">003</span>c <span class="number">0974</span> <span class="number">07</span>bb b400 cd0e</div><div class="line"><span class="number">0000520</span> eb10 f4f2 fdeb c92b <span class="number">64e4</span> <span class="number">00</span>eb <span class="number">0224</span> f8e0</div><div class="line"><span class="number">0000540</span> <span class="number">0224</span> <span class="number">49</span>c3 <span class="number">766</span>e <span class="number">6</span>c61 <span class="number">6469</span> <span class="number">7020</span> <span class="number">7261</span> <span class="number">6974</span></div><div class="line"><span class="number">0000560</span> <span class="number">6974</span> <span class="number">6e6</span>f <span class="number">7420</span> <span class="number">6261</span> <span class="number">656</span>c <span class="number">4500</span> <span class="number">7272</span> <span class="number">726</span>f</div><div class="line"><span class="number">0000600</span> <span class="number">6</span>c20 <span class="number">616</span>f <span class="number">6964</span> <span class="number">676</span>e <span class="number">6</span>f20 <span class="number">6570</span> <span class="number">6172</span> <span class="number">6974</span></div><div class="line"><span class="number">0000620</span> <span class="number">676</span>e <span class="number">7320</span> <span class="number">7379</span> <span class="number">6574</span> <span class="number">006</span>d <span class="number">694</span>d <span class="number">7373</span> <span class="number">6e69</span></div><div class="line"><span class="number">0000640</span> <span class="number">2067</span> <span class="number">706</span>f <span class="number">7265</span> <span class="number">7461</span> <span class="number">6e69</span> <span class="number">2067</span> <span class="number">7973</span> <span class="number">7473</span></div><div class="line"><span class="number">0000660</span> <span class="number">6</span>d65 <span class="number">0000</span> <span class="number">6300</span> <span class="number">9</span>a7b d681 <span class="number">4</span>aef <span class="number">0101</span> <span class="number">2080</span></div><div class="line"><span class="number">0000700</span> <span class="number">0021</span> fe07 ffff <span class="number">0800</span> <span class="number">0000</span> b000 <span class="number">0760</span> fe00</div><div class="line"><span class="number">0000720</span> ffff fe07 ffff b800 <span class="number">0760</span> <span class="number">3800</span> <span class="number">001</span>f <span class="number">0000</span></div><div class="line"><span class="number">0000740</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span></div><div class="line"><span class="number">0000760</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> aa55</div></pre></td></tr></table></figure>
<h2 id="反汇编mbr-1"><a href="#反汇编mbr-1" class="headerlink" title="反汇编mbr"></a>反汇编mbr</h2><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="number">00000000</span>  <span class="number">33</span>C0              xor ax,ax  <span class="comment">//设置ax寄存器的值为0</span></div><div class="line"><span class="number">00000002</span>  <span class="number">8</span>ED0              mov ss,ax  </div><div class="line"><span class="number">00000004</span>  BC007C            mov sp,<span class="number">0x7c00</span> <span class="comment">//设置开辟栈空间</span></div><div class="line"><span class="comment">/*</span></div><div class="line">* copying the mbr from 0x7c00 to 0x600</div><div class="line">* 200 转为十进制是 512</div><div class="line">*/</div><div class="line"><span class="number">00000007</span>  <span class="number">8</span>EC0              mov es,ax</div><div class="line"><span class="number">00000009</span>  <span class="number">8</span>ED8              mov ds,ax</div><div class="line"><span class="number">0000000</span>B  BE007C            mov si,<span class="number">0x7c00</span></div><div class="line"><span class="number">0000000</span>E  BF0006            mov di,<span class="number">0x600</span></div><div class="line"><span class="number">00000011</span>  B90002            mov cx,<span class="number">0x200</span></div><div class="line"><span class="number">00000014</span>  FC                cld  <span class="comment">// 设置寄存器为自增</span></div><div class="line"><span class="number">00000015</span>  F3A4              rep movsb  <span class="comment">//拷贝</span></div><div class="line"><span class="number">00000017</span>  <span class="number">50</span>                push ax  <span class="comment">//入栈 16bit</span></div><div class="line"><span class="number">00000018</span>  <span class="number">681</span>C06            push word <span class="number">0x61c</span> <span class="comment">//入栈</span></div><div class="line"><span class="number">0000001</span>B  CB                retf <span class="comment">//0x61c 出栈,并且调到0x61c即下一行代码处</span></div><div class="line"><span class="number">0000001</span>C  FB                sti</div><div class="line"></div><div class="line"><span class="comment">/* 下面开始循环扫描分区表(Partition Table)，寻找活动分区 0x80 总共4次 */</span></div><div class="line">  </div><div class="line"><span class="number">0000001</span>D  B90400            mov cx,<span class="number">0x4</span> <span class="comment">//总共四个分区表项</span></div><div class="line"><span class="number">00000020</span>  BDBE07            mov bp,<span class="number">0x7be</span>  <span class="comment">//分区表开始位置 偏移量是 1be + 600 = 7be</span></div><div class="line"><span class="number">00000023</span>  <span class="number">807E0000</span>          cmp byte [bp+<span class="number">0x0</span>],<span class="number">0x0</span> <span class="comment">// 第一个字节和 0比较</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">* jl 小于(有符号)，0x80 有符号是-8 成功表示找到活动分区，失败则是普通分区</div><div class="line">* 找到活动分区，跳转到0x34 </div><div class="line">*/</div><div class="line"></div><div class="line"><span class="number">00000027</span>  <span class="number">7</span>C0B              jl <span class="number">0x34</span> </div><div class="line"></div><div class="line"><span class="comment">//因为要么是 0x80 要么是0x0 别的情况表示分区表损坏输出错误信息</span></div><div class="line"><span class="number">00000029</span>  <span class="number">0</span>F850E01          jnz word <span class="number">0x13b</span> </div><div class="line"></div><div class="line"><span class="number">0000002</span>D  <span class="number">83</span>C510            add bp,byte +<span class="number">0x10</span> </div><div class="line"><span class="comment">//每个分区16字节，也就是0x10 ，调到下一个分区</span></div><div class="line"></div><div class="line"><span class="number">00000030</span>  E2F1              loop <span class="number">0x23</span> <span class="comment">//跳转到循环开始的地方，继续检测</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">* 没有发现活动分区，无法启动OS，按照规范调用Int 18h</div><div class="line">* 早期的BIOS的Int 18h中断服务程序就是启动ROM-Basic，</div><div class="line">* 现在的BIOS一般是打印错误信息</div><div class="line">*/</div><div class="line"><span class="number">00000032</span>  CD18              int <span class="number">0x18</span>  <span class="comment">//调用 终断 18</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">* 找到活动分区后，还要检查剩余分区的启动标志是否为0</div><div class="line">* 不允许存在多个活动分区</div><div class="line">*/</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">* 在 win7 的 MBR 中使用 int 0x13 扩展功能来读取磁盘</div><div class="line">* http://m.wendangku.net/doc/29a5f911a76e58fafab00369-7.html 详细介绍int 13</div><div class="line">* 因为找到0x80字段才调转的，因为dl是1byte，所以传送1byte数据到dl寄存器 </div><div class="line">* dl 是磁盘驱动器号</div><div class="line">*/</div><div class="line"><span class="number">00000034</span>  <span class="number">885600</span>            mov [bp+<span class="number">0x0</span>],dl </div><div class="line"></div><div class="line"><span class="number">00000037</span>  <span class="number">55</span>                push bp <span class="comment">//入栈</span></div><div class="line"></div><div class="line"><span class="comment">/* 如果不成功的反复读 5 次 */</span></div><div class="line"><span class="number">00000038</span>  C6461105          mov byte [bp+<span class="number">0x11</span>],<span class="number">0x5</span></div><div class="line"></div><div class="line"><span class="comment">/* 此处是一个标志位，用来记录是否支持int 0x13 扩展 */</span></div><div class="line"><span class="number">0000003</span>C  C6461000          mov byte [bp+<span class="number">0x10</span>],<span class="number">0x0</span> </div><div class="line"></div><div class="line"><span class="comment">/* 测试是否支持 int 0x13 扩展功能 */</span></div><div class="line"><span class="number">00000040</span>  B441              mov ah,<span class="number">0x41</span> <span class="comment">/* 设置扩展int 13的 参数固定 */</span></div><div class="line"><span class="number">00000042</span>  BBAA55            mov bx,<span class="number">0x55aa</span>  <span class="comment">/* 设置扩展int 13的 参数固定 */</span></div><div class="line"><span class="number">00000045</span>  CD13              int <span class="number">0x13</span></div><div class="line"><span class="number">00000047</span>  <span class="number">5</span>D                pop bp</div><div class="line"><span class="number">00000048</span>  <span class="number">720</span>F              jc <span class="number">0x59</span> <span class="comment">/* 进位标志1 则表示不支持扩展int 13 */</span></div><div class="line"><span class="number">0000004</span>A  <span class="number">81</span>FB55AA          cmp bx,<span class="number">0xaa55</span> <span class="comment">/* bx 等于 0xaa55 则表示支持 */</span></div><div class="line"><span class="number">0000004</span>E  <span class="number">7509</span>              jnz <span class="number">0x59</span> <span class="comment">/* 不支持 */</span></div><div class="line"><span class="comment">/*</span></div><div class="line">* cx 等于 0x1 表示支持第一个子集</div><div class="line">* 第一个子集提供了访问大硬盘所必须的功能,包括检查扩展In13H是否存在(41h)</div><div class="line">* 扩展读(42h),扩展写(43h),校验扇区(44h),扩展定位(47h)和取得驱动器参数(48h)</div><div class="line">*/</div><div class="line"><span class="number">00000050</span>  F7C10100          test cx,<span class="number">0x1</span> <span class="comment">/* and cx, 0x1*/</span></div><div class="line"><span class="number">00000054</span>  <span class="number">7403</span>              jz <span class="number">0x59</span> <span class="comment">/* 不支持 */</span></div><div class="line"><span class="number">00000056</span>  FE4610            inc byte [bp+<span class="number">0x10</span>] <span class="comment">/* 走到这一步表示支持 ,把标志位加1 */</span></div><div class="line"><span class="number">00000059</span>  <span class="number">6660</span>              pushad <span class="comment">/* 通用寄存器入栈，为了检查是否遍历完4个分区表 */</span></div><div class="line"><span class="number">0000005</span>B  <span class="number">807E1000</span>          cmp byte [bp+<span class="number">0x10</span>],<span class="number">0x0</span> <span class="comment">/* 查看是否支持 */</span></div><div class="line"><span class="number">0000005</span>F  <span class="number">7426</span>              jz <span class="number">0x87</span> <span class="comment">/* 不支持，则调用原始 int 13 0x87处是原始int 13 */</span></div><div class="line"></div><div class="line"><span class="comment">/*  以下是使用 int 0x13 扩展功能读 disk */</span></div><div class="line"></div><div class="line"><span class="number">00000061</span>  <span class="number">666800000000</span>      push dword <span class="number">0x0</span> <span class="comment">/* 32bit 入栈*/</span></div><div class="line"></div><div class="line"><span class="comment">/* </span></div><div class="line">* 磁盘起始位置，我们知道dpt第八字节开始存放逻辑起始扇区号</div><div class="line">* 这是要去读取活动分区的，第一个扇区分区表记录 即 ：ptr</div><div class="line">* push 的数据，其实是一个数据结构</div><div class="line">* 下面是用 c 描述为：</div><div class="line">*/</div></pre></td></tr></table></figure>
<p>struct buffer_packet<br>{<br>  short buffer_packet_size;/<em> struct’s  size </em>/<br>  short sectors; /<em> 读多少个 sectors </em>/<br>  char <em>buffer; /</em> buffer address（segment:offset 形式）<em>/<br>  long long start_sectors; /</em> 从哪个 sector 开始读 */<br>} buffer;<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div></pre></td><td class="code"><pre><div class="line"><span class="number">00000067</span>  66FF7608          <span class="keyword">push</span> <span class="built_in">dword</span> [<span class="built_in">bp</span>+<span class="number">0x8</span>]</div><div class="line">0000006B  <span class="number">680000</span>            <span class="keyword">push</span> <span class="built_in">word</span> <span class="number">0x0</span> </div><div class="line">0000006E  68007C            <span class="keyword">push</span> <span class="built_in">word</span> <span class="number">0x7c00</span> /* 传输缓冲区地址 */</div><div class="line"><span class="number">00000071</span>  <span class="number">680100</span>            <span class="keyword">push</span> <span class="built_in">word</span> <span class="number">0x1</span> /* 读取扇区的个数 */</div><div class="line"><span class="number">00000074</span>  <span class="number">681000</span>            <span class="keyword">push</span> <span class="built_in">word</span> <span class="number">0x10</span> /* 数据包尺寸一般是/ <span class="number">16</span>字节 */</div><div class="line"></div><div class="line"><span class="number">00000077</span>  B442              <span class="keyword">mov</span> <span class="number">ah</span>,<span class="number">0x42</span> /* 读磁盘 */</div><div class="line"><span class="number">00000079</span>  8A5600            <span class="keyword">mov</span> <span class="built_in">dl</span>,[<span class="built_in">bp</span>+<span class="number">0x0</span>] /* 驱动器号 */</div><div class="line">0000007C  8BF4              <span class="keyword">mov</span> <span class="built_in">si</span>,<span class="built_in">sp</span> /* buffer_packet 的 address */</div><div class="line"></div><div class="line">0000007E  CD13              <span class="keyword">int</span> <span class="number">0x13</span></div><div class="line"><span class="number">00000080</span>  9F                <span class="keyword">lahf</span></div><div class="line"><span class="number">00000081</span>  83C410            <span class="keyword">add</span> <span class="built_in">sp</span>,<span class="built_in">byte</span> +<span class="number">0x10</span></div><div class="line"><span class="number">00000084</span>  9E                <span class="keyword">sahf</span></div><div class="line"><span class="number">00000085</span>  EB14              <span class="keyword">jmp</span> short <span class="number">0x9b</span> /* 跳转到原<span class="keyword">int</span> <span class="number">13</span> 之后 */</div><div class="line">/* 使用 <span class="keyword">int</span> <span class="number">0x13</span> 原有功能来读取磁盘 */</div><div class="line">/* <span class="number">ah</span>= <span class="number">0x2</span> 功能读 <span class="built_in">al</span>=<span class="number">0x1</span> 读一个扇区*/</div><div class="line"><span class="number">00000087</span>  B80102            <span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">0x201</span> </div><div class="line">0000008A  BB007C            <span class="keyword">mov</span> <span class="built_in">bx</span>,<span class="number">0x7c00</span>   /* <span class="built_in">es</span>:<span class="built_in">bx</span> = buffer */</div><div class="line"><span class="number">0000008D</span>  8A5600            <span class="keyword">mov</span> <span class="built_in">dl</span>,[<span class="built_in">bp</span>+<span class="number">0x0</span>]  /* hard disk */</div><div class="line"><span class="number">00000090</span>  8A7601            <span class="keyword">mov</span> <span class="number">dh</span>,[<span class="built_in">bp</span>+<span class="number">0x1</span>]  /* 从哪个 head 开始读 */</div><div class="line"><span class="number">00000093</span>  8A4E02            <span class="keyword">mov</span> <span class="built_in">cl</span>,[<span class="built_in">bp</span>+<span class="number">0x2</span>]  /* 从哪个 sector 开始读 */</div><div class="line">                             /* 其中低 <span class="number">6</span> <span class="meta">bits</span> 是 sector,高<span class="number">2</span>位是cylinder */                                                       </div><div class="line"><span class="number">00000096</span>  8A6E03            <span class="keyword">mov</span> <span class="number">ch</span>,[<span class="built_in">bp</span>+<span class="number">0x3</span>]  /* 从哪个 cylinder 开始读 */</div><div class="line"><span class="number">00000099</span>  CD13              <span class="keyword">int</span> <span class="number">0x13</span></div><div class="line"></div><div class="line">/* 活动分区已经找到，并且读取了活动分区的第一个分区表记录到 <span class="number">0x7c00</span> */</div><div class="line"></div><div class="line">0000009B  <span class="number">6661</span>              <span class="keyword">popad</span> /* 通用寄存器出栈 */</div><div class="line"><span class="number">0000009D</span>  731C              <span class="keyword">jnc</span> <span class="number">0xbb</span> /* 读取成功则跳转 */</div><div class="line">0000009F  FE4E11            <span class="keyword">dec</span> <span class="built_in">byte</span> [<span class="built_in">bp</span>+<span class="number">0x11</span>] /* <span class="number">5</span>-<span class="number">1</span> ,通过这个变量来完成五次对磁盘的读 */</div><div class="line">000000A2  750C              <span class="keyword">jnz</span> <span class="number">0xb0</span> /* 不等于<span class="number">0</span> 就继续*/</div><div class="line">/* 读完五次后 ，还找不到活动分区就输出错误信息*/</div><div class="line">000000A4  807E0080          <span class="keyword">cmp</span> <span class="built_in">byte</span> [<span class="built_in">bp</span>+<span class="number">0x0</span>],<span class="number">0x80</span></div><div class="line">000000A8  0F848A00          <span class="keyword">jz</span> <span class="built_in">word</span> <span class="number">0x136</span></div><div class="line">/* 找到则去读取分区表记录信息 */</div><div class="line">000000AC  B280              <span class="keyword">mov</span> <span class="built_in">dl</span>,<span class="number">0x80</span></div><div class="line">000000AE  EB84              <span class="keyword">jmp</span> short <span class="number">0x34</span> /* 读信息 */</div><div class="line"></div><div class="line">000000B0  <span class="number">55</span>                <span class="keyword">push</span> <span class="built_in">bp</span> /**/</div><div class="line">000000B1  32E4              <span class="keyword">xor</span> <span class="number">ah</span>,<span class="number">ah</span></div><div class="line">000000B3  8A5600            <span class="keyword">mov</span> <span class="built_in">dl</span>,[<span class="built_in">bp</span>+<span class="number">0x0</span>]</div><div class="line">000000B6  CD13              <span class="keyword">int</span> <span class="number">0x13</span></div><div class="line">000000B8  <span class="number">5D</span>                <span class="keyword">pop</span> <span class="built_in">bp</span></div><div class="line">000000B9  EB9E              <span class="keyword">jmp</span> short <span class="number">0x59</span></div><div class="line">/*</div><div class="line">*代码中再次核对，是否 55aa 标志，如果不是将打印出错信息后 <span class="keyword">hlt</span></div><div class="line">*代码中还将测试键盘读/写缓冲区，然后往键盘端口 <span class="number">0x60</span> 写命令字。</div><div class="line">*<span class="keyword">call</span> <span class="built_in">word</span> <span class="number">0x156</span> 这个子过程就是测试读/写缓冲区过程。</div><div class="line">*代码最终将转去 <span class="number">0x127</span> 执行</div><div class="line">*/</div><div class="line">000000BB  813EFE7D55AA      <span class="keyword">cmp</span> <span class="built_in">word</span> [<span class="number">0x7dfe</span>],<span class="number">0xaa55</span></div><div class="line">000000C1  756E              <span class="keyword">jnz</span> <span class="number">0x131</span>  /* 不是，打印错信息，<span class="keyword">hlt</span> */</div><div class="line">000000C3  FF7600            <span class="keyword">push</span> <span class="built_in">word</span> [<span class="built_in">bp</span>+<span class="number">0x0</span>] </div><div class="line">000000C6  E88D00            <span class="keyword">call</span> <span class="built_in">word</span> <span class="number">0x156</span> /* 从 <span class="number">64H</span> 读 <span class="number">1</span> <span class="built_in">byte</span> */</div><div class="line">000000C9  <span class="number">7517</span>              <span class="keyword">jnz</span> <span class="number">0xe2</span> /* 缓冲区满，不能写*/</div><div class="line">000000CB  FA                <span class="keyword">cli</span></div><div class="line">000000CC  B0D1              <span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">0xd1</span> </div><div class="line">000000CE  E664              <span class="keyword">out</span> <span class="number">0x64</span>,<span class="built_in">al</span></div><div class="line">000000D0  E88300            <span class="keyword">call</span> <span class="built_in">word</span> <span class="number">0x156</span></div><div class="line">000000D3  B0DF              <span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">0xdf</span></div><div class="line">000000D5  E660              <span class="keyword">out</span> <span class="number">0x60</span>,<span class="built_in">al</span></div><div class="line">000000D7  E87C00            <span class="keyword">call</span> <span class="built_in">word</span> <span class="number">0x156</span></div><div class="line">000000DA  B0FF              <span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">0xff</span></div><div class="line">000000DC  E664              <span class="keyword">out</span> <span class="number">0x64</span>,<span class="built_in">al</span></div><div class="line">000000DE  E87500            <span class="keyword">call</span> <span class="built_in">word</span> <span class="number">0x156</span></div><div class="line">000000E1  FB                <span class="keyword">sti</span></div><div class="line">000000E2  B800BB            <span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">0xbb00</span></div><div class="line">000000E5  CD1A              <span class="keyword">int</span> <span class="number">0x1a</span></div><div class="line">000000E7  6623C0            <span class="keyword">and</span> <span class="built_in">eax</span>,<span class="built_in">eax</span></div><div class="line">000000EA  753B              <span class="keyword">jnz</span> <span class="number">0x127</span></div><div class="line">000000EC  6681FB54435041    <span class="keyword">cmp</span> <span class="built_in">ebx</span>,<span class="number">0x41504354</span></div><div class="line">000000F3  <span class="number">7532</span>              <span class="keyword">jnz</span> <span class="number">0x127</span></div><div class="line">000000F5  81F90201          <span class="keyword">cmp</span> <span class="built_in">cx</span>,<span class="number">0x102</span></div><div class="line">000000F9  722C              <span class="keyword">jc</span> <span class="number">0x127</span></div><div class="line">/*</div><div class="line">* 不明白 <span class="keyword">int</span> <span class="number">0x1a</span> 中断的</div><div class="line">*/</div><div class="line">000000FB  666807BB0000      <span class="keyword">push</span> <span class="built_in">dword</span> <span class="number">0xbb07</span></div><div class="line"><span class="number">00000101</span>  <span class="number">666800020000</span>      <span class="keyword">push</span> <span class="built_in">dword</span> <span class="number">0x200</span></div><div class="line"><span class="number">00000107</span>  <span class="number">666808000000</span>      <span class="keyword">push</span> <span class="built_in">dword</span> <span class="number">0x8</span></div><div class="line"><span class="number">0000010D</span>  <span class="number">6653</span>              <span class="keyword">push</span> <span class="built_in">ebx</span></div><div class="line">0000010F  <span class="number">6653</span>              <span class="keyword">push</span> <span class="built_in">ebx</span></div><div class="line"><span class="number">00000111</span>  <span class="number">6655</span>              <span class="keyword">push</span> <span class="built_in">ebp</span></div><div class="line"><span class="number">00000113</span>  <span class="number">666800000000</span>      <span class="keyword">push</span> <span class="built_in">dword</span> <span class="number">0x0</span></div><div class="line"><span class="number">00000119</span>  6668007C0000      <span class="keyword">push</span> <span class="built_in">dword</span> <span class="number">0x7c00</span></div><div class="line">0000011F  <span class="number">6661</span>              <span class="keyword">popad</span></div><div class="line"><span class="number">00000121</span>  <span class="number">680000</span>            <span class="keyword">push</span> <span class="built_in">word</span> <span class="number">0x0</span></div><div class="line"><span class="number">00000124</span>  <span class="number">07</span>                <span class="keyword">pop</span> <span class="built_in">es</span></div><div class="line"><span class="number">00000125</span>  CD1A              <span class="keyword">int</span> <span class="number">0x1a</span></div><div class="line"></div><div class="line">/* </div><div class="line">* 代码最终回到<span class="number">0x7c00</span> ,继续执行从活动分区的第一个扇区拷贝的代码</div><div class="line">*/</div><div class="line"><span class="number">00000127</span>  5A                <span class="keyword">pop</span> <span class="built_in">dx</span></div><div class="line"><span class="number">00000128</span>  32F6              <span class="keyword">xor</span> <span class="number">dh</span>,<span class="number">dh</span></div><div class="line">0000012A  EA007C0000        <span class="keyword">jmp</span> <span class="built_in">word</span> <span class="number">0x0</span>:<span class="number">0x7c00</span></div><div class="line">0000012F  CD18              <span class="keyword">int</span> <span class="number">0x18</span> /* 不明白 */</div><div class="line"></div><div class="line">/* 打印出错信息，<span class="keyword">hlt</span> */</div><div class="line"><span class="number">00000131</span>  A0B707            <span class="keyword">mov</span> <span class="built_in">al</span>,[<span class="number">0x7b7</span>]   /* 索引号为 9A */</div><div class="line"><span class="number">00000134</span>  EB08              <span class="keyword">jmp</span> short <span class="number">0x13e</span></div><div class="line"><span class="number">00000136</span>  A0B607            <span class="keyword">mov</span> <span class="built_in">al</span>,[<span class="number">0x7b6</span>]    /* 索引号为 7B */</div><div class="line"><span class="number">00000139</span>  EB03              <span class="keyword">jmp</span> short <span class="number">0x13e</span></div><div class="line">0000013B  A0B507            <span class="keyword">mov</span> <span class="built_in">al</span>,[<span class="number">0x7b5</span>]     /* 索引号为 <span class="number">63</span> */</div><div class="line">0000013E  32E4              <span class="keyword">xor</span> <span class="number">ah</span>,<span class="number">ah</span></div><div class="line"><span class="number">00000140</span>  <span class="number">050007</span>            <span class="keyword">add</span> <span class="built_in">ax</span>,<span class="number">0x700</span></div><div class="line"><span class="number">00000143</span>  8BF0              <span class="keyword">mov</span> <span class="built_in">si</span>,<span class="built_in">ax</span></div><div class="line"><span class="number">00000145</span>  AC                <span class="keyword">lodsb</span></div><div class="line"><span class="number">00000146</span>  3C00              <span class="keyword">cmp</span> <span class="built_in">al</span>,<span class="number">0x0</span></div><div class="line"><span class="number">00000148</span>  <span class="number">7409</span>              <span class="keyword">jz</span> <span class="number">0x153</span></div><div class="line">0000014A  BB0700            <span class="keyword">mov</span> <span class="built_in">bx</span>,<span class="number">0x7</span></div><div class="line"><span class="number">0000014D</span>  B40E              <span class="keyword">mov</span> <span class="number">ah</span>,<span class="number">0xe</span></div><div class="line">0000014F  CD10              <span class="keyword">int</span> <span class="number">0x10</span></div><div class="line"><span class="number">00000151</span>  EBF2              <span class="keyword">jmp</span> short <span class="number">0x145</span></div><div class="line"><span class="number">00000153</span>  F4                <span class="keyword">hlt</span></div><div class="line"><span class="number">00000154</span>  EBFD              <span class="keyword">jmp</span> short <span class="number">0x153</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="number">00000156</span>  2BC9              <span class="keyword">sub</span> <span class="built_in">cx</span>,<span class="built_in">cx</span></div><div class="line"><span class="number">00000158</span>  E464              <span class="keyword">in</span> <span class="built_in">al</span>,<span class="number">0x64</span></div><div class="line">0000015A  EB00              <span class="keyword">jmp</span> short <span class="number">0x15c</span></div><div class="line">0000015C  <span class="number">2402</span>              <span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">0x2</span></div><div class="line">0000015E  E0F8              <span class="keyword">loopne</span> <span class="number">0x158</span></div><div class="line"><span class="number">00000160</span>  <span class="number">2402</span>              <span class="keyword">and</span> <span class="built_in">al</span>,<span class="number">0x2</span></div><div class="line"><span class="number">00000162</span>  C3                <span class="keyword">ret</span></div><div class="line">/********** 下面的区域是 mbr 常量符： mbr_str　**************/</div><div class="line">/*</div><div class="line">* <span class="number">163</span>----1b2</div><div class="line">char *mbr_str = <span class="string">"Invalid partition table."</span></div><div class="line"><span class="string">"Error loading operation system."</span></div><div class="line"><span class="string">"Missing operation system."</span></div><div class="line">*/</div><div class="line"><span class="number">00000163</span>  <span class="number">49</span>                <span class="keyword">dec</span> <span class="built_in">cx</span></div><div class="line"><span class="number">00000164</span>  6E                <span class="keyword">outsb</span></div><div class="line"><span class="number">00000165</span>  <span class="number">7661</span>              <span class="keyword">jna</span> <span class="number">0x1c8</span></div><div class="line"><span class="number">00000167</span>  6C                <span class="keyword">insb</span></div><div class="line"><span class="number">00000168</span>  <span class="number">6964207061</span>        <span class="keyword">imul</span> <span class="built_in">sp</span>,[<span class="built_in">si</span>+<span class="number">0x20</span>],<span class="built_in">word</span> <span class="number">0x6170</span></div><div class="line"><span class="number">0000016D</span>  <span class="number">7274</span>              <span class="keyword">jc</span> <span class="number">0x1e3</span></div><div class="line">0000016F  6974696F6E        <span class="keyword">imul</span> <span class="built_in">si</span>,[<span class="built_in">si</span>+<span class="number">0x69</span>],<span class="built_in">word</span> <span class="number">0x6e6f</span></div><div class="line"><span class="number">00000174</span>  <span class="number">207461</span>            <span class="keyword">and</span> [<span class="built_in">si</span>+<span class="number">0x61</span>],<span class="number">dh</span></div><div class="line"><span class="number">00000177</span>  626C65            <span class="keyword">bound</span> <span class="built_in">bp</span>,[<span class="built_in">si</span>+<span class="number">0x65</span>]</div><div class="line">0000017A  <span class="number">004572</span>            <span class="keyword">add</span> [<span class="built_in">di</span>+<span class="number">0x72</span>],<span class="built_in">al</span></div><div class="line"><span class="number">0000017D</span>  726F              <span class="keyword">jc</span> <span class="number">0x1ee</span></div><div class="line">0000017F  <span class="number">7220</span>              <span class="keyword">jc</span> <span class="number">0x1a1</span></div><div class="line"><span class="number">00000181</span>  6C                <span class="keyword">insb</span></div><div class="line"><span class="number">00000182</span>  6F                <span class="keyword">outsw</span></div><div class="line"><span class="number">00000183</span>  <span class="number">61</span>                <span class="keyword">popaw</span></div><div class="line"><span class="number">00000184</span>  64696E67206F      <span class="keyword">imul</span> <span class="built_in">bp</span>,[<span class="built_in">fs</span>:<span class="built_in">bp</span>+<span class="number">0x67</span>],<span class="built_in">word</span> <span class="number">0x6f20</span></div><div class="line">0000018A  <span class="number">7065</span>              <span class="keyword">jo</span> <span class="number">0x1f1</span></div><div class="line">0000018C  <span class="number">7261</span>              <span class="keyword">jc</span> <span class="number">0x1ef</span></div><div class="line">0000018E  <span class="number">7469</span>              <span class="keyword">jz</span> <span class="number">0x1f9</span></div><div class="line"><span class="number">00000190</span>  6E                <span class="keyword">outsb</span></div><div class="line"><span class="number">00000191</span>  <span class="number">67207379</span>          <span class="keyword">and</span> [<span class="built_in">ebx</span>+<span class="number">0x79</span>],<span class="number">dh</span></div><div class="line"><span class="number">00000195</span>  <span class="number">7374</span>              <span class="keyword">jnc</span> <span class="number">0x20b</span></div><div class="line"><span class="number">00000197</span>  <span class="number">656D</span>              <span class="built_in">gs</span> <span class="keyword">insw</span></div><div class="line"><span class="number">00000199</span>  004D69            <span class="keyword">add</span> [<span class="built_in">di</span>+<span class="number">0x69</span>],<span class="built_in">cl</span></div><div class="line">0000019C  <span class="number">7373</span>              <span class="keyword">jnc</span> <span class="number">0x211</span></div><div class="line">0000019E  696E67206F        <span class="keyword">imul</span> <span class="built_in">bp</span>,[<span class="built_in">bp</span>+<span class="number">0x67</span>],<span class="built_in">word</span> <span class="number">0x6f20</span></div><div class="line">000001A3  <span class="number">7065</span>              <span class="keyword">jo</span> <span class="number">0x20a</span></div><div class="line">000001A5  <span class="number">7261</span>              <span class="keyword">jc</span> <span class="number">0x208</span></div><div class="line">000001A7  <span class="number">7469</span>              <span class="keyword">jz</span> <span class="number">0x212</span></div><div class="line">000001A9  6E                <span class="keyword">outsb</span></div><div class="line">000001AA  <span class="number">67207379</span>          <span class="keyword">and</span> [<span class="built_in">ebx</span>+<span class="number">0x79</span>],<span class="number">dh</span></div><div class="line">000001AE  <span class="number">7374</span>              <span class="keyword">jnc</span> <span class="number">0x224</span></div><div class="line">000001B0  <span class="number">656D</span>              <span class="built_in">gs</span> <span class="keyword">insw</span></div><div class="line"></div><div class="line">/*</div><div class="line">* 下面是字符串索引值 </div><div class="line">* 在出错处理过程里，根据索引值找到相应的出错信息</div><div class="line">* 然后使用 <span class="keyword">int</span> <span class="number">0x10</span> 打印出错信息，最后是 <span class="keyword">hlt</span> 停机指令。</div><div class="line">*/</div><div class="line">000001B2  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001B4  00637B            <span class="keyword">add</span> [<span class="built_in">bp</span>+<span class="built_in">di</span>+<span class="number">0x7b</span>],<span class="number">ah</span></div><div class="line">000001B7  9A81D6EF4A        <span class="keyword">call</span> <span class="built_in">word</span> <span class="number">0x4aef</span>:<span class="number">0xd681</span></div><div class="line">000001BC  <span class="number">0101</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">di</span>],<span class="built_in">ax</span></div><div class="line"></div><div class="line">/*</div><div class="line">下面是磁盘分区表 64<span class="built_in">byte</span></div><div class="line">*/</div><div class="line">000001BE  <span class="number">802021</span>            <span class="keyword">and</span> <span class="built_in">byte</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="number">0x21</span></div><div class="line">000001C1  <span class="number">0007</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>],<span class="built_in">al</span></div><div class="line">000001C3  FE                <span class="built_in">db</span> <span class="number">0xfe</span></div><div class="line">000001C4  FF                <span class="built_in">db</span> <span class="number">0xff</span></div><div class="line">000001C5  FF00              <span class="keyword">inc</span> <span class="built_in">word</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>]</div><div class="line">000001C7  <span class="number">0800</span>              <span class="keyword">or</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001C9  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001CB  B060              <span class="keyword">mov</span> <span class="built_in">al</span>,<span class="number">0x60</span></div><div class="line">000001CD  <span class="number">07</span>                <span class="keyword">pop</span> <span class="built_in">es</span></div><div class="line">000001CE  00FE              <span class="keyword">add</span> <span class="number">dh</span>,<span class="number">bh</span></div><div class="line">000001D0  FF                <span class="built_in">db</span> <span class="number">0xff</span></div><div class="line">000001D1  FF07              <span class="keyword">inc</span> <span class="built_in">word</span> [<span class="built_in">bx</span>]</div><div class="line">000001D3  FE                <span class="built_in">db</span> <span class="number">0xfe</span></div><div class="line">000001D4  FF                <span class="built_in">db</span> <span class="number">0xff</span></div><div class="line">000001D5  FF00              <span class="keyword">inc</span> <span class="built_in">word</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>]</div><div class="line">000001D7  B86007            <span class="keyword">mov</span> <span class="built_in">ax</span>,<span class="number">0x760</span></div><div class="line">000001DA  <span class="number">0038</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="number">bh</span></div><div class="line">000001DC  1F                <span class="keyword">pop</span> <span class="built_in">ds</span></div><div class="line">000001<span class="built_in">DD</span>  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001DF  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001E1  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001E3  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001E5  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001E7  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001E9  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001EB  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001ED  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001EF  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001F1  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001F3  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001F5  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001F7  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001F9  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001FB  <span class="number">0000</span>              <span class="keyword">add</span> [<span class="built_in">bx</span>+<span class="built_in">si</span>],<span class="built_in">al</span></div><div class="line">000001FD  0055AA            <span class="keyword">add</span> [<span class="built_in">di</span>-<span class="number">0x56</span>],<span class="built_in">dl</span></div><div class="line">0x56u</div></pre></td></tr></table></figure></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://notelzg.github.io/2016/07/17/disamy-mbr/" data-id="cj03otiox0008j6yp4xjcuk1n" class="article-share-link">分享到</a><div class="tags"><a href="/tags/反汇编/">反汇编</a><a href="/tags/MBR/">MBR</a><a href="/tags/引导部分详解/">引导部分详解</a></div><div class="post-nav"><a href="/2016/07/30/note-tcp-ip-volume1/" class="pre">note_tcp/ip_volume1</a><a href="/2016/07/15/yyjBirth/" class="next">yyjBirth</a></div><div id="disqus_thread"><script>var disqus_shortname = 'notelzg';
var disqus_identifier = '2016/07/17/disamy-mbr/';
var disqus_title = 'disamy-mbr';
var disqus_url = 'https://notelzg.github.io/2016/07/17/disamy-mbr/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//notelzg.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://notelzg.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/学习笔记/">学习笔记</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/学习笔记/接口/">接口</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习笔记/教程/">教程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习笔记/生活笔记/">生活笔记</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/学习笔记/生活笔记/教程/">教程</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/教程/">教程</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/教程/git/">git</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活笔记/">生活笔记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/thread/" style="font-size: 15px;">thread</a> <a href="/tags/笔记/" style="font-size: 15px;">笔记</a> <a href="/tags/MBR/" style="font-size: 15px;">MBR</a> <a href="/tags/引导部分详解/" style="font-size: 15px;">引导部分详解</a> <a href="/tags/Unix-linux/" style="font-size: 15px;">Unix&linux</a> <a href="/tags/tcp-ip/" style="font-size: 15px;">tcp/ip</a> <a href="/tags/操作系统/" style="font-size: 15px;">操作系统</a> <a href="/tags/Archlinux/" style="font-size: 15px;">Archlinux</a> <a href="/tags/无线网络/" style="font-size: 15px;">无线网络</a> <a href="/tags/Ubuntu/" style="font-size: 15px;">Ubuntu</a> <a href="/tags/Solarized-Colorscheme/" style="font-size: 15px;">Solarized Colorscheme</a> <a href="/tags/gnome/" style="font-size: 15px;">gnome</a> <a href="/tags/unix/" style="font-size: 15px;">unix</a> <a href="/tags/反汇编/" style="font-size: 15px;">反汇编</a> <a href="/tags/Unix-Linux/" style="font-size: 15px;">Unix&Linux</a> <a href="/tags/fork/" style="font-size: 15px;">fork</a> <a href="/tags/unix-linux/" style="font-size: 15px;">unix&linux</a> <a href="/tags/IPC-Interprocess-Communication/" style="font-size: 15px;">IPC(Interprocess Communication)</a> <a href="/tags/issues/" style="font-size: 15px;">issues</a> <a href="/tags/Birthday/" style="font-size: 15px;">Birthday</a> <a href="/tags/汇编/" style="font-size: 15px;">汇编</a> <a href="/tags/assembly/" style="font-size: 15px;">assembly</a> <a href="/tags/8086/" style="font-size: 15px;">8086</a> <a href="/tags/王爽/" style="font-size: 15px;">王爽</a> <a href="/tags/linux-unix/" style="font-size: 15px;">linux&unix</a> <a href="/tags/os/" style="font-size: 15px;">os</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/03/10/interview-wanmei/">interview-wanmei</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/07/linux-c-extern-static/">linux-c-extern-static</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/29/archlinx-wireless-issus/">archlinx-wireless-issus</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/29/archlinux-无线网络配/">archlinux 无线网络配</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/23/unix进程通信/">unix进程通信</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/21/unix环境高级编程读后感/">unix环境高级编程读后感</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/20/unix--线程同步/">unix线程同步</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/20/unix--进程控制/">unix进程控制</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/20/unix--线程控制/">unix线程控制</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/20/unix-redirect-infile/">unix-redirect-infile</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.csdn.net/li740207611" title="csdn" target="_blank">csdn</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">blogLi.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>