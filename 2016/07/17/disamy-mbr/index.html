<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Recoding my grow of technology."><title>disamy-mbr | blogLi</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">disamy-mbr</h1><a id="logo" href="/.">blogLi</a><p class="description">学生，码农，工程师</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a><a href="/comments"><i class="fa fa-comments"> 留言</i></a><a href="/books"><i class="fa fa-rss"> 书单</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">disamy-mbr</h1><div class="post-meta">Jul 17, 2016<span> | </span><span class="category"><a href="/categories/学习笔记/">学习笔记</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/07/17/disamy-mbr/" href="/2016/07/17/disamy-mbr/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#"><span class="toc-number">1.</span> <span class="toc-text"></span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#window开机流程"><span class="toc-number"></span> <span class="toc-text">window开机流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#流程"><span class="toc-number">1.</span> <span class="toc-text">流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#细节"><span class="toc-number">2.</span> <span class="toc-text">细节</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#获取"><span class="toc-number"></span> <span class="toc-text">获取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#获取mbr"><span class="toc-number">1.</span> <span class="toc-text">获取mbr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装"><span class="toc-number">2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#反汇编mbr"><span class="toc-number">3.</span> <span class="toc-text">反汇编mbr</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#分析"><span class="toc-number"></span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#二进制mbr"><span class="toc-number">1.</span> <span class="toc-text">二进制mbr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#反汇编mbr-1"><span class="toc-number">2.</span> <span class="toc-text">反汇编mbr</span></a></li></ol></div></div><div class="post-content"><p> 今天把我们每次开机都用到的MBR，反汇编看看里面的引导代码是怎么样的顺便说一下<br> MBR 相关的开机过程。以及我们经常用的U盘自启动<br> 程序到底值怎么玩的。</p>
<h2 id=""><a href="#" class="headerlink" title=""></a><a id="more"></a></h2><h1 id="window开机流程"><a href="#window开机流程" class="headerlink" title="window开机流程"></a>window开机流程</h1><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><pre><code>加电--&gt;BIOS--&gt; MBR--&gt; DPT--&gt; pbr--&gt; Bootmgr--&gt; bcd--&gt; Winload.exe---
</code></pre><p>—-&gt; 内核加载–&gt; 整个windows7系统</p>
<h2 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h2><p>在CPU上电之后，若由硬盘启动，则BIOS将硬盘的主引导记录（位于0柱面、0磁道、1扇区）读入7C00处<br>然后将控制权交给主引导代码。主引导代码的任务包括：<br>扫描分区表，找到一个激活(可引导)分区；<br>找到激活分区的起始扇区；<br>将激活分区的引导扇区装载到内存7C00处；<br>将控制权交给引导扇区代码；</p>
<p>如果主引导代码无法完成上述任务，它将显示以下错误信息之一：<br>No active partition.<br>Invalid partition table.<br>Error loading operating system.<br>Missing operating system.</p>
<p>机器加电或按reset键后都要进行系统复位，复位后CS=FFFFH，IP=0000H，那么自然就从FFFF:0000H<br>处开始执行指令，这个地方只有一条JMP指令跳转到系统自检程序处，系统自检完成后把软盘的第一<br>个扇区（如果由软盘启动）或者硬盘的第一个扇区，即MBR扇区（如果由硬盘启动）读入到0:7C00H处<br>然后把控制权交出，从0:7C00H处继续执行。  </p>
<p>下面就是硬盘的MBR代码分析：<br>其中的引导扇区是指硬盘相应分区的第一个扇区，是和操作系统有关的。操作系统的引导是由它来完成的，而MBR并不负责，MBR和操作系统无关。引导扇区的任务是把控制权转交给操作系统的引导程序。 </p>
<p>程序流程：<br>1 将程序代码由0:7C00H移动到0:0600H（注，BIOS把MBR放在0:7C00H处）<br>2 搜索可引导分区，即80H标志<br>成功：goto 3<br>失败：跳入ROM BASIC<br>无效分区表：goto 5<br>3 读引导扇区<br>失败：goto 5<br>成功：goto 4<br>4 验证引导扇区最后是否为55AAH<br>失败：goto 5<br>成功：goto 6<br>5 打印错误进入无穷循环<br>6 跳到0:7C00H进行下一步启动工作</p>
<h1 id="获取"><a href="#获取" class="headerlink" title="获取"></a>获取</h1><h2 id="获取mbr"><a href="#获取mbr" class="headerlink" title="获取mbr"></a>获取mbr</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">window可以直接用hex打开，然后直接拷贝成文件</div><div class="line">linux一条dd 命令搞定，参数不明白就 --help look</div><div class="line"></div><div class="line">dd if=/dev/sda of=~/Desktop/mbr.bin bs=512 count=1</div></pre></td></tr></table></figure>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">安装nasm </div><div class="line">sudo apt-get install nasms</div></pre></td></tr></table></figure>
<h2 id="反汇编mbr"><a href="#反汇编mbr" class="headerlink" title="反汇编mbr"></a>反汇编mbr</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//把mbr.bin 反汇编到mbr.asm</div><div class="line">ndisasm mbr.bin &gt; mbr.asm</div></pre></td></tr></table></figure>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><h2 id="二进制mbr"><a href="#二进制mbr" class="headerlink" title="二进制mbr"></a>二进制mbr</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">od -x mbr.bin</div><div class="line">0000000 c033 d08e 00bc 8e7c 8ec0 bed8 7c00 00bf</div><div class="line">0000020 b906 0200 f3fc 50a4 1c68 cb06 b9fb 0004</div><div class="line">0000040 bebd 8007 007e 7c00 0f0b 0e85 8301 10c5</div><div class="line">0000060 f1e2 18cd 5688 5500 46c6 0511 46c6 0010</div><div class="line">0000100 41b4 aabb cd55 5d13 0f72 fb81 aa55 0975</div><div class="line">0000120 c1f7 0001 0374 46fe 6610 8060 107e 7400</div><div class="line">0000140 6626 0068 0000 6600 76ff 6808 0000 0068</div><div class="line">0000160 687c 0001 1068 b400 8a42 0056 f48b 13cd</div><div class="line">0000200 839f 10c4 eb9e b814 0201 00bb 8a7c 0056</div><div class="line">0000220 768a 8a01 024e 6e8a cd03 6613 7361 fe1c</div><div class="line">0000240 114e 0c75 7e80 8000 840f 008a 80b2 84eb</div><div class="line">0000260 3255 8ae4 0056 13cd eb5d 819e fe3e 557d</div><div class="line">0000300 75aa ff6e 0076 8de8 7500 fa17 d1b0 64e6</div><div class="line">0000320 83e8 b000 e6df e860 007c ffb0 64e6 75e8</div><div class="line">0000340 fb00 00b8 cdbb 661a c023 3b75 8166 54fb</div><div class="line">0000360 5043 7541 8132 02f9 7201 662c 0768 00bb</div><div class="line">0000400 6600 0068 0002 6600 0868 0000 6600 6653</div><div class="line">0000420 6653 6655 0068 0000 6600 0068 007c 6600</div><div class="line">0000440 6861 0000 cd07 5a1a f632 00ea 007c cd00</div><div class="line">0000460 a018 07b7 08eb b6a0 eb07 a003 07b5 e432</div><div class="line">0000500 0005 8b07 acf0 003c 0974 07bb b400 cd0e</div><div class="line">0000520 eb10 f4f2 fdeb c92b 64e4 00eb 0224 f8e0</div><div class="line">0000540 0224 49c3 766e 6c61 6469 7020 7261 6974</div><div class="line">0000560 6974 6e6f 7420 6261 656c 4500 7272 726f</div><div class="line">0000600 6c20 616f 6964 676e 6f20 6570 6172 6974</div><div class="line">0000620 676e 7320 7379 6574 006d 694d 7373 6e69</div><div class="line">0000640 2067 706f 7265 7461 6e69 2067 7973 7473</div><div class="line">0000660 6d65 0000 6300 9a7b d681 4aef 0101 2080</div><div class="line">0000700 0021 fe07 ffff 0800 0000 b000 0760 fe00</div><div class="line">0000720 ffff fe07 ffff b800 0760 3800 001f 0000</div><div class="line">0000740 0000 0000 0000 0000 0000 0000 0000 0000</div><div class="line">0000760 0000 0000 0000 0000 0000 0000 0000 aa55</div></pre></td></tr></table></figure>
<h2 id="反汇编mbr-1"><a href="#反汇编mbr-1" class="headerlink" title="反汇编mbr"></a>反汇编mbr</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">00000000  33C0              xor ax,ax  //设置ax寄存器的值为0</div><div class="line">00000002  8ED0              mov ss,ax  </div><div class="line">00000004  BC007C            mov sp,0x7c00 //设置开辟栈空间</div><div class="line">/*</div><div class="line">* copying the mbr from 0x7c00 to 0x600</div><div class="line">* 200 转为十进制是 512</div><div class="line">*/</div><div class="line">00000007  8EC0              mov es,ax</div><div class="line">00000009  8ED8              mov ds,ax</div><div class="line">0000000B  BE007C            mov si,0x7c00</div><div class="line">0000000E  BF0006            mov di,0x600</div><div class="line">00000011  B90002            mov cx,0x200</div><div class="line">00000014  FC                cld  // 设置寄存器为自增</div><div class="line">00000015  F3A4              rep movsb  //拷贝</div><div class="line">00000017  50                push ax  //入栈 16bit</div><div class="line">00000018  681C06            push word 0x61c //入栈</div><div class="line">0000001B  CB                retf //0x61c 出栈,并且调到0x61c即下一行代码处</div><div class="line">0000001C  FB                sti</div><div class="line"></div><div class="line">/* 下面开始循环扫描分区表(Partition Table)，寻找活动分区 0x80 总共4次 */</div><div class="line">  </div><div class="line">0000001D  B90400            mov cx,0x4 //总共四个分区表项</div><div class="line">00000020  BDBE07            mov bp,0x7be  //分区表开始位置 偏移量是 1be + 600 = 7be</div><div class="line">00000023  807E0000          cmp byte [bp+0x0],0x0 // 第一个字节和 0比较</div><div class="line"></div><div class="line">/*</div><div class="line">* jl 小于(有符号)，0x80 有符号是-8 成功表示找到活动分区，失败则是普通分区</div><div class="line">* 找到活动分区，跳转到0x34 </div><div class="line">*/</div><div class="line"></div><div class="line">00000027  7C0B              jl 0x34 </div><div class="line"></div><div class="line">//因为要么是 0x80 要么是0x0 别的情况表示分区表损坏输出错误信息</div><div class="line">00000029  0F850E01          jnz word 0x13b </div><div class="line"></div><div class="line">0000002D  83C510            add bp,byte +0x10 </div><div class="line">//每个分区16字节，也就是0x10 ，调到下一个分区</div><div class="line"></div><div class="line">00000030  E2F1              loop 0x23 //跳转到循环开始的地方，继续检测</div><div class="line"></div><div class="line">/*</div><div class="line">* 没有发现活动分区，无法启动OS，按照规范调用Int 18h</div><div class="line">* 早期的BIOS的Int 18h中断服务程序就是启动ROM-Basic，</div><div class="line">* 现在的BIOS一般是打印错误信息</div><div class="line">*/</div><div class="line">00000032  CD18              int 0x18  //调用 终断 18</div><div class="line"></div><div class="line">/*</div><div class="line">* 找到活动分区后，还要检查剩余分区的启动标志是否为0</div><div class="line">* 不允许存在多个活动分区</div><div class="line">*/</div><div class="line"></div><div class="line"></div><div class="line">/*</div><div class="line">* 在 win7 的 MBR 中使用 int 0x13 扩展功能来读取磁盘</div><div class="line">* http://m.wendangku.net/doc/29a5f911a76e58fafab00369-7.html 详细介绍int 13</div><div class="line">* 因为找到0x80字段才调转的，因为dl是1byte，所以传送1byte数据到dl寄存器 </div><div class="line">* dl 是磁盘驱动器号</div><div class="line">*/</div><div class="line">00000034  885600            mov [bp+0x0],dl </div><div class="line"></div><div class="line">00000037  55                push bp //入栈</div><div class="line"></div><div class="line">/* 如果不成功的反复读 5 次 */</div><div class="line">00000038  C6461105          mov byte [bp+0x11],0x5</div><div class="line"></div><div class="line">/* 此处是一个标志位，用来记录是否支持int 0x13 扩展 */</div><div class="line">0000003C  C6461000          mov byte [bp+0x10],0x0 </div><div class="line"></div><div class="line">/* 测试是否支持 int 0x13 扩展功能 */</div><div class="line">00000040  B441              mov ah,0x41 /* 设置扩展int 13的 参数固定 */</div><div class="line">00000042  BBAA55            mov bx,0x55aa  /* 设置扩展int 13的 参数固定 */</div><div class="line">00000045  CD13              int 0x13</div><div class="line">00000047  5D                pop bp</div><div class="line">00000048  720F              jc 0x59 /* 进位标志1 则表示不支持扩展int 13 */</div><div class="line">0000004A  81FB55AA          cmp bx,0xaa55 /* bx 等于 0xaa55 则表示支持 */</div><div class="line">0000004E  7509              jnz 0x59 /* 不支持 */</div><div class="line">/*</div><div class="line">* cx 等于 0x1 表示支持第一个子集</div><div class="line">* 第一个子集提供了访问大硬盘所必须的功能,包括检查扩展In13H是否存在(41h)</div><div class="line">* 扩展读(42h),扩展写(43h),校验扇区(44h),扩展定位(47h)和取得驱动器参数(48h)</div><div class="line">*/</div><div class="line">00000050  F7C10100          test cx,0x1 /* and cx, 0x1*/</div><div class="line">00000054  7403              jz 0x59 /* 不支持 */</div><div class="line">00000056  FE4610            inc byte [bp+0x10] /* 走到这一步表示支持 ,把标志位加1 */</div><div class="line">00000059  6660              pushad /* 通用寄存器入栈，为了检查是否遍历完4个分区表 */</div><div class="line">0000005B  807E1000          cmp byte [bp+0x10],0x0 /* 查看是否支持 */</div><div class="line">0000005F  7426              jz 0x87 /* 不支持，则调用原始 int 13 0x87处是原始int 13 */</div><div class="line"></div><div class="line">/*  以下是使用 int 0x13 扩展功能读 disk */</div><div class="line"></div><div class="line">00000061  666800000000      push dword 0x0 /* 32bit 入栈*/</div><div class="line"></div><div class="line">/* </div><div class="line">* 磁盘起始位置，我们知道dpt第八字节开始存放逻辑起始扇区号</div><div class="line">* 这是要去读取活动分区的，第一个扇区分区表记录 即 ：ptr</div><div class="line">* push 的数据，其实是一个数据结构</div><div class="line">* 下面是用 c 描述为：</div><div class="line">*/</div></pre></td></tr></table></figure>
<p>struct buffer_packet<br>{<br>  short buffer_packet_size;/<em> struct’s  size </em>/<br>  short sectors; /<em> 读多少个 sectors </em>/<br>  char <em>buffer; /</em> buffer address（segment:offset 形式）<em>/<br>  long long start_sectors; /</em> 从哪个 sector 开始读 */<br>} buffer;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div></pre></td><td class="code"><pre><div class="line">00000067  66FF7608          push dword [bp+0x8]</div><div class="line">0000006B  680000            push word 0x0 </div><div class="line">0000006E  68007C            push word 0x7c00 /* 传输缓冲区地址 */</div><div class="line">00000071  680100            push word 0x1 /* 读取扇区的个数 */</div><div class="line">00000074  681000            push word 0x10 /* 数据包尺寸一般是/ 16字节 */</div><div class="line"></div><div class="line">00000077  B442              mov ah,0x42 /* 读磁盘 */</div><div class="line">00000079  8A5600            mov dl,[bp+0x0] /* 驱动器号 */</div><div class="line">0000007C  8BF4              mov si,sp /* buffer_packet 的 address */</div><div class="line"></div><div class="line">0000007E  CD13              int 0x13</div><div class="line">00000080  9F                lahf</div><div class="line">00000081  83C410            add sp,byte +0x10</div><div class="line">00000084  9E                sahf</div><div class="line">00000085  EB14              jmp short 0x9b /* 跳转到原int 13 之后 */</div><div class="line">/* 使用 int 0x13 原有功能来读取磁盘 */</div><div class="line">/* ah= 0x2 功能读 al=0x1 读一个扇区*/</div><div class="line">00000087  B80102            mov ax,0x201 </div><div class="line">0000008A  BB007C            mov bx,0x7c00   /* es:bx = buffer */</div><div class="line">0000008D  8A5600            mov dl,[bp+0x0]  /* hard disk */</div><div class="line">00000090  8A7601            mov dh,[bp+0x1]  /* 从哪个 head 开始读 */</div><div class="line">00000093  8A4E02            mov cl,[bp+0x2]  /* 从哪个 sector 开始读 */</div><div class="line">                             /* 其中低 6 bits 是 sector,高2位是cylinder */                                                       </div><div class="line">00000096  8A6E03            mov ch,[bp+0x3]  /* 从哪个 cylinder 开始读 */</div><div class="line">00000099  CD13              int 0x13</div><div class="line"></div><div class="line">/* 活动分区已经找到，并且读取了活动分区的第一个分区表记录到 0x7c00 */</div><div class="line"></div><div class="line">0000009B  6661              popad /* 通用寄存器出栈 */</div><div class="line">0000009D  731C              jnc 0xbb /* 读取成功则跳转 */</div><div class="line">0000009F  FE4E11            dec byte [bp+0x11] /* 5-1 ,通过这个变量来完成五次对磁盘的读 */</div><div class="line">000000A2  750C              jnz 0xb0 /* 不等于0 就继续*/</div><div class="line">/* 读完五次后 ，还找不到活动分区就输出错误信息*/</div><div class="line">000000A4  807E0080          cmp byte [bp+0x0],0x80</div><div class="line">000000A8  0F848A00          jz word 0x136</div><div class="line">/* 找到则去读取分区表记录信息 */</div><div class="line">000000AC  B280              mov dl,0x80</div><div class="line">000000AE  EB84              jmp short 0x34 /* 读信息 */</div><div class="line"></div><div class="line">000000B0  55                push bp /**/</div><div class="line">000000B1  32E4              xor ah,ah</div><div class="line">000000B3  8A5600            mov dl,[bp+0x0]</div><div class="line">000000B6  CD13              int 0x13</div><div class="line">000000B8  5D                pop bp</div><div class="line">000000B9  EB9E              jmp short 0x59</div><div class="line">/*</div><div class="line">*代码中再次核对，是否 55aa 标志，如果不是将打印出错信息后 hlt</div><div class="line">*代码中还将测试键盘读/写缓冲区，然后往键盘端口 0x60 写命令字。</div><div class="line">*call word 0x156 这个子过程就是测试读/写缓冲区过程。</div><div class="line">*代码最终将转去 0x127 执行</div><div class="line">*/</div><div class="line">000000BB  813EFE7D55AA      cmp word [0x7dfe],0xaa55</div><div class="line">000000C1  756E              jnz 0x131  /* 不是，打印错信息，hlt */</div><div class="line">000000C3  FF7600            push word [bp+0x0] </div><div class="line">000000C6  E88D00            call word 0x156 /* 从 64H 读 1 byte */</div><div class="line">000000C9  7517              jnz 0xe2 /* 缓冲区满，不能写*/</div><div class="line">000000CB  FA                cli</div><div class="line">000000CC  B0D1              mov al,0xd1 </div><div class="line">000000CE  E664              out 0x64,al</div><div class="line">000000D0  E88300            call word 0x156</div><div class="line">000000D3  B0DF              mov al,0xdf</div><div class="line">000000D5  E660              out 0x60,al</div><div class="line">000000D7  E87C00            call word 0x156</div><div class="line">000000DA  B0FF              mov al,0xff</div><div class="line">000000DC  E664              out 0x64,al</div><div class="line">000000DE  E87500            call word 0x156</div><div class="line">000000E1  FB                sti</div><div class="line">000000E2  B800BB            mov ax,0xbb00</div><div class="line">000000E5  CD1A              int 0x1a</div><div class="line">000000E7  6623C0            and eax,eax</div><div class="line">000000EA  753B              jnz 0x127</div><div class="line">000000EC  6681FB54435041    cmp ebx,0x41504354</div><div class="line">000000F3  7532              jnz 0x127</div><div class="line">000000F5  81F90201          cmp cx,0x102</div><div class="line">000000F9  722C              jc 0x127</div><div class="line">/*</div><div class="line">* 不明白 int 0x1a 中断的</div><div class="line">*/</div><div class="line">000000FB  666807BB0000      push dword 0xbb07</div><div class="line">00000101  666800020000      push dword 0x200</div><div class="line">00000107  666808000000      push dword 0x8</div><div class="line">0000010D  6653              push ebx</div><div class="line">0000010F  6653              push ebx</div><div class="line">00000111  6655              push ebp</div><div class="line">00000113  666800000000      push dword 0x0</div><div class="line">00000119  6668007C0000      push dword 0x7c00</div><div class="line">0000011F  6661              popad</div><div class="line">00000121  680000            push word 0x0</div><div class="line">00000124  07                pop es</div><div class="line">00000125  CD1A              int 0x1a</div><div class="line"></div><div class="line">/* </div><div class="line">* 代码最终回到0x7c00 ,继续执行从活动分区的第一个扇区拷贝的代码</div><div class="line">*/</div><div class="line">00000127  5A                pop dx</div><div class="line">00000128  32F6              xor dh,dh</div><div class="line">0000012A  EA007C0000        jmp word 0x0:0x7c00</div><div class="line">0000012F  CD18              int 0x18 /* 不明白 */</div><div class="line"></div><div class="line">/* 打印出错信息，hlt */</div><div class="line">00000131  A0B707            mov al,[0x7b7]   /* 索引号为 9A */</div><div class="line">00000134  EB08              jmp short 0x13e</div><div class="line">00000136  A0B607            mov al,[0x7b6]    /* 索引号为 7B */</div><div class="line">00000139  EB03              jmp short 0x13e</div><div class="line">0000013B  A0B507            mov al,[0x7b5]     /* 索引号为 63 */</div><div class="line">0000013E  32E4              xor ah,ah</div><div class="line">00000140  050007            add ax,0x700</div><div class="line">00000143  8BF0              mov si,ax</div><div class="line">00000145  AC                lodsb</div><div class="line">00000146  3C00              cmp al,0x0</div><div class="line">00000148  7409              jz 0x153</div><div class="line">0000014A  BB0700            mov bx,0x7</div><div class="line">0000014D  B40E              mov ah,0xe</div><div class="line">0000014F  CD10              int 0x10</div><div class="line">00000151  EBF2              jmp short 0x145</div><div class="line">00000153  F4                hlt</div><div class="line">00000154  EBFD              jmp short 0x153</div><div class="line"></div><div class="line"></div><div class="line">00000156  2BC9              sub cx,cx</div><div class="line">00000158  E464              in al,0x64</div><div class="line">0000015A  EB00              jmp short 0x15c</div><div class="line">0000015C  2402              and al,0x2</div><div class="line">0000015E  E0F8              loopne 0x158</div><div class="line">00000160  2402              and al,0x2</div><div class="line">00000162  C3                ret</div><div class="line">/********** 下面的区域是 mbr 常量符： mbr_str　**************/</div><div class="line">/*</div><div class="line">* 163----1b2</div><div class="line">char *mbr_str = &quot;Invalid partition table.&quot;</div><div class="line">&quot;Error loading operation system.&quot;</div><div class="line">&quot;Missing operation system.&quot;</div><div class="line">*/</div><div class="line">00000163  49                dec cx</div><div class="line">00000164  6E                outsb</div><div class="line">00000165  7661              jna 0x1c8</div><div class="line">00000167  6C                insb</div><div class="line">00000168  6964207061        imul sp,[si+0x20],word 0x6170</div><div class="line">0000016D  7274              jc 0x1e3</div><div class="line">0000016F  6974696F6E        imul si,[si+0x69],word 0x6e6f</div><div class="line">00000174  207461            and [si+0x61],dh</div><div class="line">00000177  626C65            bound bp,[si+0x65]</div><div class="line">0000017A  004572            add [di+0x72],al</div><div class="line">0000017D  726F              jc 0x1ee</div><div class="line">0000017F  7220              jc 0x1a1</div><div class="line">00000181  6C                insb</div><div class="line">00000182  6F                outsw</div><div class="line">00000183  61                popaw</div><div class="line">00000184  64696E67206F      imul bp,[fs:bp+0x67],word 0x6f20</div><div class="line">0000018A  7065              jo 0x1f1</div><div class="line">0000018C  7261              jc 0x1ef</div><div class="line">0000018E  7469              jz 0x1f9</div><div class="line">00000190  6E                outsb</div><div class="line">00000191  67207379          and [ebx+0x79],dh</div><div class="line">00000195  7374              jnc 0x20b</div><div class="line">00000197  656D              gs insw</div><div class="line">00000199  004D69            add [di+0x69],cl</div><div class="line">0000019C  7373              jnc 0x211</div><div class="line">0000019E  696E67206F        imul bp,[bp+0x67],word 0x6f20</div><div class="line">000001A3  7065              jo 0x20a</div><div class="line">000001A5  7261              jc 0x208</div><div class="line">000001A7  7469              jz 0x212</div><div class="line">000001A9  6E                outsb</div><div class="line">000001AA  67207379          and [ebx+0x79],dh</div><div class="line">000001AE  7374              jnc 0x224</div><div class="line">000001B0  656D              gs insw</div><div class="line"></div><div class="line">/*</div><div class="line">* 下面是字符串索引值 </div><div class="line">* 在出错处理过程里，根据索引值找到相应的出错信息</div><div class="line">* 然后使用 int 0x10 打印出错信息，最后是 hlt 停机指令。</div><div class="line">*/</div><div class="line">000001B2  0000              add [bx+si],al</div><div class="line">000001B4  00637B            add [bp+di+0x7b],ah</div><div class="line">000001B7  9A81D6EF4A        call word 0x4aef:0xd681</div><div class="line">000001BC  0101              add [bx+di],ax</div><div class="line"></div><div class="line">/*</div><div class="line">下面是磁盘分区表 64byte</div><div class="line">*/</div><div class="line">000001BE  802021            and byte [bx+si],0x21</div><div class="line">000001C1  0007              add [bx],al</div><div class="line">000001C3  FE                db 0xfe</div><div class="line">000001C4  FF                db 0xff</div><div class="line">000001C5  FF00              inc word [bx+si]</div><div class="line">000001C7  0800              or [bx+si],al</div><div class="line">000001C9  0000              add [bx+si],al</div><div class="line">000001CB  B060              mov al,0x60</div><div class="line">000001CD  07                pop es</div><div class="line">000001CE  00FE              add dh,bh</div><div class="line">000001D0  FF                db 0xff</div><div class="line">000001D1  FF07              inc word [bx]</div><div class="line">000001D3  FE                db 0xfe</div><div class="line">000001D4  FF                db 0xff</div><div class="line">000001D5  FF00              inc word [bx+si]</div><div class="line">000001D7  B86007            mov ax,0x760</div><div class="line">000001DA  0038              add [bx+si],bh</div><div class="line">000001DC  1F                pop ds</div><div class="line">000001DD  0000              add [bx+si],al</div><div class="line">000001DF  0000              add [bx+si],al</div><div class="line">000001E1  0000              add [bx+si],al</div><div class="line">000001E3  0000              add [bx+si],al</div><div class="line">000001E5  0000              add [bx+si],al</div><div class="line">000001E7  0000              add [bx+si],al</div><div class="line">000001E9  0000              add [bx+si],al</div><div class="line">000001EB  0000              add [bx+si],al</div><div class="line">000001ED  0000              add [bx+si],al</div><div class="line">000001EF  0000              add [bx+si],al</div><div class="line">000001F1  0000              add [bx+si],al</div><div class="line">000001F3  0000              add [bx+si],al</div><div class="line">000001F5  0000              add [bx+si],al</div><div class="line">000001F7  0000              add [bx+si],al</div><div class="line">000001F9  0000              add [bx+si],al</div><div class="line">000001FB  0000              add [bx+si],al</div><div class="line">000001FD  0055AA            add [di-0x56],dl</div><div class="line">0x56u</div></pre></td></tr></table></figure></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://notelzg.github.io/2016/07/17/disamy-mbr/" data-id="cirfzjc7k00028jyp8ojq5xya" class="article-share-link">分享到</a><div class="tags"><a href="/tags/反汇编/">反汇编</a><a href="/tags/MBR/">MBR</a><a href="/tags/引导部分详解/">引导部分详解</a></div><div class="post-nav"><a href="/2016/07/30/note-tcp-ip-volume1/" class="pre">note_tcp/ip_volume1</a><a href="/2016/07/15/yyjBirth/" class="next">yyjBirth</a></div><div id="disqus_thread"><script>var disqus_shortname = 'notelzg';
var disqus_identifier = '2016/07/17/disamy-mbr/';
var disqus_title = 'disamy-mbr';
var disqus_url = 'https://notelzg.github.io/2016/07/17/disamy-mbr/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//notelzg.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://notelzg.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/学习笔记/">学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/建站笔记/">建站笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活笔记/">生活笔记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/笔记/" style="font-size: 15px;">笔记</a> <a href="/tags/反汇编/" style="font-size: 15px;">反汇编</a> <a href="/tags/引导部分详解/" style="font-size: 15px;">引导部分详解</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/issus/" style="font-size: 15px;">issus</a> <a href="/tags/tcp-ip/" style="font-size: 15px;">tcp/ip</a> <a href="/tags/操作系统/" style="font-size: 15px;">操作系统</a> <a href="/tags/MBR/" style="font-size: 15px;">MBR</a> <a href="/tags/Birthday/" style="font-size: 15px;">Birthday</a> <a href="/tags/汇编/" style="font-size: 15px;">汇编</a> <a href="/tags/assembly/" style="font-size: 15px;">assembly</a> <a href="/tags/8086/" style="font-size: 15px;">8086</a> <a href="/tags/王爽/" style="font-size: 15px;">王爽</a> <a href="/tags/os/" style="font-size: 15px;">os</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/08/04/README/">README</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/04/hello-world/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/04/index/">index</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/30/note-tcp-ip-volume1/">note_tcp/ip_volume1</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/17/disamy-mbr/">disamy-mbr</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/15/yyjBirth/">yyjBirth</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/30/深入理解计算机系统总结/">深入理解计算机系统笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/28/hexo-issues/">hexo-issues</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/20/os_summary/">OS</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/08/汇编语言王爽/">汇编语言王爽</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.csdn.net/li740207611" title="csdn" target="_blank">csdn</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">blogLi.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>